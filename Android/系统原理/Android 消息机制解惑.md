# Android 消息机制解惑

[TOC]

前提, 熟知Android消息机制, 根据此机制可以手写自己的消息框架. 

重点提示:

- 命令模式
- 单链表存储消息

解惑问题:

1. `Handler`消息机制为何会出现?

   因为Android 的GUI和别的GUI系统一样, 是单线程的. 只能在主线程中处理和UI相关的操作. 原因是多线程GUI特别容易受到死锁的影响. 用户的动作和操作系统的动作, 在访问控件是完全相反的顺序, 这样由于竞争条件导致死锁问题. 所以, 使用了单线程模型, 有专门的事件派发线程负责访问组件这些UI.

   

2. `Looper`在主线程(ActivityThread)中无限循环, 为何没有引起`ANR`? 

   在ActivityThread里:

   ```
   public static void main(String[] args) {
       // ...
       Looper.prepareMainLooper();
       Looper.loop();
       // ...
   }
   ```

   

   `loop()`的无限循环,在消息队列没有消息的时候, `queue.next()`会阻塞, 此时主线程会释放CPU资源进入休眠状态, 直到新消息到达, 通过往pipe管道写端写入数据来唤醒主线程. 所以主线程大部分时间是处于休眠状态的. 

    

3. Handler是如何进行线程切换的 ? 

   Handler使用当前线程的`Looper`来轮询取出消息. `Looper`由`ThreadLocal`维护, 线程和`Looper`一 一对应. 

   子线程是没有Looper的, 如果需要在子线程中使用Handler, 要先调用`Looper.prepare()`.

   

   费曼学习法一共有4个步骤：第1步，学习一样新东西之后，用尽可能简单的语言解释给小孩子听，或者对相关课题不了解的朋友听。第2步，找出别人听不懂的地方，或者是你本身无法简单解释的概念。第3步，回到你的学习资源，重新学习你的弱点，意识到能够简单地解释清楚为止。第4步，重复以上三个步骤，一直到你完全熟练相关的课题为止。



   

   



















































































